# docker-multistage

## before

Before docker multi-stage builds, it was necessary to define multiple
Dockerfiles: An image for building the app, and a small production image for
running the app (containing the application + OS-installed dependencies).
aka - the Builder Pattern.

`before/Dockerfile.build`: golang base image

- sets the working directory
- copies source code into workdir
- retrieves dependencies (`net/html`)
- runs `go build`, outputs `app` executable

`before/Dockerfile`: alpine base image

- installs os-level dependencies
- sets the working directory
- executes `app` when container starts

`before/build.sh`:

- builds the intermediate container (`Dockerfile.build` with tag `href-counter:build`)
- starts the intermediate build container
- copies `app` executable from container to local filesystem
- removes the build container
- builds the distributable container (`Dockerfile` with tag `href-counter:latest`)
- removes `app` executable from the local filesystem

commands:

```bash
$ cd before
$ ./build.sh
$ docker run alexellis2/href-counter:latest
```

## present

Multi-stage builds can simplify this process of building and preparing a
distributable container. In your `Dockerfile`, selectively copy artifacts
generated by previous stages into the resulting container.

`present/Dockerfile`:

- each `FROM` statement starts a new stage
- first stage builds the app with golang
- second stage copies the app from first stage into the resulting container

commands:

```bash
$ docker build -t alexellis2/href-counter:latest .
```

## benefits

- smaller image size
- leaves behind unnecessary binaries and files from previous steps
- no need to create intermediate images
- reduces the `build.sh` script to a single command

## build a specific stage

```bash
$ docker build --target builder -t alexellis2/href-counter:latest .
```

## copy from an external image

Artifacts can come from any image on Docker Hub, or other container registry. ðŸ˜®

```Dockerfile
COPY --from=nginx:latest /etc/nginx/nginx.conf /nginx.conf
```

[[source](https://docs.docker.com/develop/develop-images/multistage-build/)]

## resources

- https://lipanski.com/posts/dockerfile-ruby-best-practices
